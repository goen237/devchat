services:

  # Redis Cache & Session Store
  # Verwendet für:
  # - Token Blacklist (Logout)
  # - Rate Limiting (Spam-Schutz)
  # - Caching (Performance)
  redis:
    image: redis:7-alpine
    container_name: devchat-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    # Redis Configuration (ohne Passwort für lokale Entwicklung)
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - devchat-network
    restart: unless-stopped

  # Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.backend
    container_name: devchat-backend
    env_file:
      - ./backend/.env
    # Force Google DNS for better IPv4 resolution
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 2001:4860:4860::8888
    ports:
      - "4000:4000"
    volumes:
      - ./backend/public/avatars:/app/public/avatars
      - ./backend/uploads:/app/uploads
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - devchat-network
    restart: unless-stopped
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.frontend
    container_name: devchat-frontend
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:4000}
    ports:
      - "5173:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - devchat-network
    restart: unless-stopped

networks:
  devchat-network:
     driver: bridge
     enable_ipv6: true
     ipam:
        config:
          - subnet: 172.20.0.0/16
            gateway: 172.20.0.1
          - subnet: 2001:db8:1::/64
            gateway: 2001:db8:1::1

volumes:
  redis_data:  # Redis persistenter Speicher

